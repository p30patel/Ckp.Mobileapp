
'use strict';

app.factory("messageDataService", [
                "$http", "$q", "localStorageService", "ngAuthSettings", "authService",
                function ($http, $q, localStorageService, ngAuthSettings, authService) {
                    var messageDataServiceFactory = {};
                    var refereshPeriod = new Date().getDay() % 2 == 0;
                    
                    var forceGetMessages = function () {
                        var deferred = $q.defer();
                        var authServiceBase = ngAuthSettings.authServiceBaseUri;

                        var authData = authService.getUserInfo();
                        var userId = authData.userId;
                      
                        $http.get(authServiceBase + 'webapi/api/core/MobileApp/GetMessageListTaskAsync?userId=' + userId).success(function (result) {
                            localStorageService.set('messages' + refereshPeriod, result);
                            deferred.resolve(result);
                        })
                            .error(function (err, status) {
                                deferred.reject(err);
                            });
                        return deferred.promise;
                    };
                    var getMessages = function () {
                        var deferred = $q.defer();
                        var forceReferesh = false; // refresh the page once a day
                        var messages = localStorageService.get("messages" + refereshPeriod);
                        messages = { "PartnerHolidayList": [{ "PartnerId": 6328, "StartDate": "2015-09-26T00:00:00", "EndDate": "2015-09-30T00:00:00", "HolidayDescription": "special holiday", "Name": "Meto UK", "Id": 1774, "Error": "" }, { "PartnerId": 6337, "StartDate": "2015-09-30T00:00:00", "EndDate": "2015-09-30T00:00:00", "HolidayDescription": "Spring Break", "Name": "Costa Mesa, CA Laser", "Id": 1775, "Error": "" }], "AnnouncementList": [{ "Message": "<b>Maintenance Schedule</b><br>Attention CheckNet Users. This website will be down for scheduled maintenance on October 25, 2014 from 9am to 11am ET. Thank you for your understanding as we strive to provide you with better user experience.", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": true, "Title": "CheckNet Maintenance", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 9, "Error": "" }, { "Message": "Thank you for your participation as a pilot customer for this program as we strive to improve your CheckNet's ordering experience. To take advantage of the site's full functionality, we advise that you use the latest version of browser available for your computer. <br><br>We value your inputs for feedback and suggestions.", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": true, "Title": "Welcome to CheckNet's New Look", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 11, "Error": "" }, { "Message": "test", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "test", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 79, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 19, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 21, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 22, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 23, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 35, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Testing", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 37, "Error": "" }, { "Message": "Test retailer message", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": " Message Marshall's 1", "SpecificRetailerId": 10354, "AnnouncementBanks": [], "RetailerName": null, "Id": 39, "Error": "" }, { "Message": "Start on 1/31", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Delay Message", "SpecificRetailerId": 10354, "AnnouncementBanks": [], "RetailerName": null, "Id": 40, "Error": "" }, { "Message": "Do you see what I see ?", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "For Akcam's Eyes Only !!!", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 49, "Error": "" }, { "Message": "QA Testing is Ongoing", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 34899, "AnnouncementBanks": [], "RetailerName": null, "Id": 51, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 105696, "AnnouncementBanks": [], "RetailerName": null, "Id": 54, "Error": "" }, { "Message": "FOX RACING test message", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 2449, "AnnouncementBanks": [], "RetailerName": null, "Id": 55, "Error": "" }, { "Message": "Ticket B already available for ordering in catalog. ", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "New Ticket Available !!!", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 56, "Error": "" }, { "Message": "This message is only for PUMA vendor and nobody else.", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "For PUMA Vendor ... ", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 57, "Error": "" }, { "Message": "Hello this is marshalls", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "This is a new message for BHeim", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 58, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 29843, "AnnouncementBanks": [], "RetailerName": null, "Id": 59, "Error": "" }, { "Message": "PLease be advised that a new ticket called URB012 is now available in the catalog section. ", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "New Ticket \"URB012\" Available for Catalog", "SpecificRetailerId": 9638, "AnnouncementBanks": [], "RetailerName": null, "Id": 60, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 29218, "AnnouncementBanks": [], "RetailerName": null, "Id": 61, "Error": "" }, { "Message": "good evening, araneta!", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "testing for message", "SpecificRetailerId": 129, "AnnouncementBanks": [], "RetailerName": null, "Id": 45, "Error": "" }, { "Message": "Message", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Title", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 64, "Error": "" }, { "Message": "Message", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Title", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 64, "Error": "" }, { "Message": "hello world", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "hello world", "SpecificRetailerId": 129, "AnnouncementBanks": [], "RetailerName": null, "Id": 66, "Error": "" }, { "Message": "hello world", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Hello world", "SpecificRetailerId": 566, "AnnouncementBanks": [], "RetailerName": null, "Id": 69, "Error": "" }, { "Message": "This is a test message.", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Hello", "SpecificRetailerId": 33613, "AnnouncementBanks": [], "RetailerName": null, "Id": 70, "Error": "" }, { "Message": "Hello Checknet User", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "New Checknet user", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 71, "Error": "" }, { "Message": "", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 72, "Error": "" }, { "Message": "Date Validation Message", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Date Validation Test", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 73, "Error": "" }, { "Message": "Akcam", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Test akcam only ", "SpecificRetailerId": 6884, "AnnouncementBanks": [], "RetailerName": null, "Id": 46, "Error": "" }, { "Message": "<i>This is where we display customer <br> related messages. Setting is at customer <br> level and will show up on any user under <br> them (customer, vendor, factory).</i> ", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Reminders", "SpecificRetailerId": 678, "AnnouncementBanks": [], "RetailerName": null, "Id": 50, "Error": "" }, { "Message": "Welcome to \"Coldwater Creek\"", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "Hello World!", "SpecificRetailerId": 678, "AnnouncementBanks": [], "RetailerName": null, "Id": 74, "Error": "" }, { "Message": "test", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "check", "SpecificRetailerId": 678, "AnnouncementBanks": [], "RetailerName": null, "Id": 75, "Error": "" }, { "Message": "sample", "StartDate": "2015-08-07T00:00:00", "EndDate": "2015-08-30T00:00:00", "IsHtml": false, "Title": "sample", "SpecificRetailerId": 0, "AnnouncementBanks": [], "RetailerName": null, "Id": 80, "Error": "" }] };
                        if (messages) {
                            deferred.resolve(messages);
                        } else {
                            forceReferesh = true;
                        }

                        if (forceReferesh)
                        {
                            forceGetMessages().then(function (result) {
                                deferred.resolve(result);
                        });
                        }

                        return deferred.promise;
                    }

                    messageDataServiceFactory.getMessages = getMessages;
                    messageDataServiceFactory.forceGetMessages = forceGetMessages;

                    return messageDataServiceFactory;
                }
            ]);